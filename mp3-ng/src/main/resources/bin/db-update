#!/bin/bash

# Go recursively up to find the mountpoint
# $1 - path
function findmountpoint()
{
  dir=$(dirname $1)
  mountpoint $dir
  if [ "$?" != 0 ]
  then
    findmountpoint $(dirname $dir)
  else
    mp=$dir
  fi
}

script=$(readlink -f $0)

if [ -z "$M3_LIBRARY_HOME" ]
then
  findmountpoint $script
  M3_LIBRARY_HOME=$mp
fi

m3util=$(basename $script)

echo "### Assuming $M3_LIBRARY_HOME as media library root!"

source $M3_LIBRARY_HOME/tools/etc/m3util.conf

if [ -z "$JAVA_HOME" ]
then
  export JAVA_HOME=$M3_LIBRARY_HOME/tools/lib/jre1.7.0_05
  export PATH=$PATH:$JAVA_HOME/bin
  export LD_LIBRARY_PATH=$PATH:$JAVA_HOME/lib
fi

export CLASSPATH=$M3_LIBRARY_HOME/tools/lib/m3util/mp3-ng-1.0.0-SNAPSHOT.jar:$M3_LIBRARY_HOME/tools/lib/m3util/fawkez-commons-2.0.0.jar:$M3_LIBRARY_HOME/tools/lib/m3util/lucene-core-3.6.0.jar:$M3_LIBRARY_HOME/tools/lib/m3util/jaudiotagger-2.0.3.jar

java -DM3_LIBRARY_HOME=$M3_LIBRARY_HOME org.jcoderz.mp3.intern.lucene.DatabaseUpdater $*

